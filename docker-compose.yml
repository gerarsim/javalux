version: '3.8'

services:
  app:
    build:
      context: .
      # Choose the Dockerfile that matches your project structure:
      # - Dockerfile.simple: For pre-built JAR files
      # - Dockerfile.full-build: For standard Spring Boot + React in root
      # - Dockerfile.monorepo: For separate /frontend and /backend folders
      dockerfile: Dockerfile.simple
    container_name: compliance-app
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Database configuration
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/compliancedb
      - SPRING_DATASOURCE_USERNAME=appuser
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}

      # Luxembourg timezone
      - TZ=Europe/Luxembourg

      # Security settings
      - SPRING_SECURITY_ENABLED=true
      - SESSION_TIMEOUT=1800

      # GDPR compliance settings
      - DATA_RETENTION_DAYS=2555  # 7 years for Luxembourg legal requirements
      - AUDIT_LOG_ENABLED=true
      - ENCRYPTION_ENABLED=true

      # Application settings
      - SERVER_PORT=8080
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_APP=DEBUG

    volumes:
      # Persistent logs for audit trails
      - ./logs:/app/logs
      # Configuration files
      - ./config:/app/config:ro

    networks:
      - app-network

    depends_on:
      db:
        condition: service_healthy

    # Security options
    security_opt:
      - no-new-privileges:true

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  db:
    image: postgres:15-alpine
    container_name: compliance-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=compliancedb
      - POSTGRES_USER=appuser
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - TZ=Europe/Luxembourg
      - PGTZ=Europe/Luxembourg

    volumes:
      # Persistent database storage
      - db-data:/var/lib/postgresql/data
      # Initialization scripts
      - ./db/init:/docker-entrypoint-initdb.d:ro

    networks:
      - app-network

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U appuser -d compliancedb"]
      interval: 10s
      timeout: 5s
      retries: 5

    # Security options
    security_opt:
      - no-new-privileges:true

  # Optional: Nginx reverse proxy for SSL/TLS termination
  nginx:
    image: nginx:alpine
    container_name: compliance-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    networks:
      - app-network
    depends_on:
      - app
    security_opt:
      - no-new-privileges:true

networks:
  app-network:
    driver: bridge

volumes:
  db-data:
    driver: local